<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Caminho Seguro — Sudeste (Leaflet + OSRM)</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		:root{
			--bg:#0a0f1c; --panel:#111827; --card:#1f2937; --muted:#9ca3af;
			--ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --accent:#3b82f6; --border:#374151;
		}
		*{box-sizing:border-box}
		body{margin:0;background:var(--bg);color:#f9fafb;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
		header{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border)}
		.wrap{max-width:1400px;margin:0 auto;padding:16px}
		.row{display:grid;grid-template-columns:1fr 1fr 200px auto;gap:12px;align-items:end}
		label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
		select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
		button{background:linear-gradient(90deg,var(--ok),#059669);font-weight:700;border:none;cursor:pointer}
		#map{height:calc(100vh - 210px)}
		.legend{display:flex;gap:16px;align-items:center;margin-top:10px;padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:12px}
		.dot{width:12px;height:12px;border-radius:999px;display:inline-block}
		.alto{background:var(--danger)} .medio{background:var(--warn)} .baixo{background:var(--ok)}
		.panel{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
		.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
		.score{font-size:24px;font-weight:800}
		.pill{display:inline-block;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:2px 8px;font-size:12px;color:#cbd5e1}
		.loading{opacity:.7}
		/* Leaflet popup dark */
		.leaflet-popup-content-wrapper{background:var(--card);border:1px solid var(--border);border-radius:12px}
		.leaflet-popup-content{color:#f9fafb;margin:12px}
		.leaflet-popup-tip{background:var(--card);border:1px solid var(--border)}
	</style>
</head>
<body>
	<header>
		<div class="wrap">
			<div class="row">
				<div>
					<label>Origem</label>
					<select id="origin">
						<option value="-22.9068,-43.1729">Rio de Janeiro, RJ</option>
						<option value="-23.5505,-46.6333">São Paulo, SP</option>
						<option value="-19.9167,-43.9345">Belo Horizonte, MG</option>
						<option value="-20.3197,-40.3378">Vitória, ES</option>
						<option value="-22.9099,-47.0626">Campinas, SP</option>
						<option value="-22.8832,-43.1034">Niterói, RJ</option>
						<option value="-21.7642,-43.3503">Juiz de Fora, MG</option>
						<option value="-18.9186,-48.2772">Uberlândia, MG</option>
						<option value="-23.4543,-46.5337">Guarulhos, SP</option>
						<option value="-20.1211,-40.3074">Serra, ES</option>
					</select>
				</div>
				<div>
					<label>Destino</label>
					<select id="destination">
						<option value="-20.3197,-40.3378">Vitória, ES</option>
						<option value="-22.9068,-43.1729">Rio de Janeiro, RJ</option>
						<option value="-23.5505,-46.6333">São Paulo, SP</option>
						<option value="-19.9167,-43.9345">Belo Horizonte, MG</option>
						<option value="-22.9099,-47.0626">Campinas, SP</option>
						<option value="-22.8832,-43.1034">Niterói, RJ</option>
						<option value="-21.7642,-43.3503">Juiz de Fora, MG</option>
						<option value="-18.9186,-48.2772">Uberlândia, MG</option>
						<option value="-23.4543,-46.5337">Guarulhos, SP</option>
						<option value="-20.1211,-40.3074">Serra, ES</option>
					</select>
				</div>
				<div>
					<label>Buffer</label>
					<select id="buffer">
						<option value="500" selected>500 m</option>
						<option value="750">750 m</option>
						<option value="1000">1 km</option>
					</select>
				</div>
				<div>
					<button id="go">Traçar rota segura</button>
				</div>
			</div>

			<div class="panel">
				<div class="card">
					<div style="color:var(--muted);font-size:12px">Rotas avaliadas</div>
					<div id="routesInfo" class="small">—</div>
				</div>
				<div class="card">
					<div style="color:var(--muted);font-size:12px">Pontuação (menor = mais segura)</div>
					<div id="bestScore" class="score">—</div>
					<div id="scoreBreakdown" style="color:var(--muted);font-size:12px"></div>
				</div>
			</div>

			<div class="legend">
				<span class="dot alto"></span> Alto (3)
				<span class="dot medio"></span> Médio (2)
				<span class="dot baixo"></span> Baixo (1)
				<span class="pill">Fonte: trecho_moda.geojson</span>
			</div>
		</div>
	</header>

	<div id="map"></div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
	<script>
	// ================== CONFIG ==================
	const ACCIDENTS_GEOJSON_URL = "trecho_moda.geojson";
	const OSRM_SELFHOST_URL = "http://127.0.0.1:5000/route/v1";
	const WEIGHT_3 = 5, WEIGHT_2 = 2, WEIGHT_1 = 0;

	// ================== MAPA ====================
	const map = L.map('map', { preferCanvas:true }).setView([-21.0, -43.5], 6);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(map);

	// ================== DADOS ===================
	let accidents = [];         // todos (com br)
	let accIndex = new Map();   // grid para busca rápida
	let accLayer = L.layerGroup().addTo(map);
	let routesLayer = L.layerGroup().addTo(map);

	function makePopupHTML(p){
		const tag = p.alert_label ? p.alert_label.toUpperCase() : (p.alert_level===3?'ALTO RISCO':p.alert_level===2?'MÉDIO RISCO':'BAIXO RISCO');
		const pr = p.props || {};
		const rows = [];
		if (pr.characteristics) rows.push(['Ponto', pr.characteristics]);
		if (pr.trecho) rows.push(['Trecho', pr.trecho]);
		if (pr.city || pr.uf) rows.push(['Cidade/UF', `${pr.city||'-'}/${pr.uf||'-'}`]);
		if (pr.br) rows.push(['BR', pr.br]);

		for (const [k,label] of [
			['weather','Condição'],['road_type','Tipo de pista'],
			['weekday','Dia da semana'],['time','Horário'],
			['deaths','Mortes'],['injuries_severe','Feridos graves'],
			['injuries_minor','Feridos leves'],
		]){
			if (pr[k]!==undefined && pr[k]!==null && String(pr[k]).trim()!=='') {
				rows.push([label, pr[k]]);
			}
		}

		const trs = rows.map(([k,v])=>`<tr><td style="padding:4px 8px;color:#9ca3af;font-weight:600">${k}</td><td>${v}</td></tr>`).join('');
		return `<div style="min-width:280px">
			<div style="background:${p.color};color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;margin-bottom:8px">${tag}</div>
			<table style="width:100%;font-size:13px">${trs || '<tr><td colspan="2" style="color:#9ca3af">Sem detalhes</td></tr>'}</table>
		</div>`;
	}

	async function loadAccidents(){
		const res = await fetch(ACCIDENTS_GEOJSON_URL);
		const gj = await res.json();

		accidents = (gj.features||[])
			.filter(f => f.geometry?.type === 'Point')
			.map(f => {
				const [lng, lat] = f.geometry.coordinates;
				const pr = f.properties || {};
				const alert_level = Number(pr.alert_level) || 1;
				const color = alert_level===3 ? '#ef4444' : alert_level===2 ? '#f59e0b' : '#10b981';
				const p = { lat, lng, alert_level, alert_label: pr.alert_label, color, props: pr };
				p.popupHTML = makePopupHTML(p);
				return p;
			});

		// índice espacial simples (grid 0.1 grau)
		accidents.forEach(p=>{
			const cell = `${Math.floor(p.lat*10)}_${Math.floor(p.lng*10)}`;
			if(!accIndex.has(cell)) accIndex.set(cell, []);
			accIndex.get(cell).push(p);
		});
	}

	// ========== GEO HELPERS ==========
	function haversine(a,b){
		const R=6371000,toRad=x=>x*Math.PI/180;
		const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
		const lat1=toRad(a.lat), lat2=toRad(b.lat);
		const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
		return 2*R*Math.asin(Math.sqrt(h));
	}
	function samplePolyline(latlngs, everyMeters=400){
		const out=[]; let acc=0;
		for(let i=1;i<latlngs.length;i++){
			const a=latlngs[i-1], b=latlngs[i];
			const d=haversine(a,b); acc+=d;
			if(acc>=everyMeters){ out.push({lat:b.lat,lng:b.lng}); acc=0; }
		}
		if(!out.length && latlngs.length){
			const last = latlngs[latlngs.length-1];
			out.push({lat:last.lat,lng:last.lng});
		}
		return out;
	}
	function nearbyPoints(lat,lng){
		const cLat=Math.floor(lat*10), cLng=Math.floor(lng*10);
		const pts=[];
		for(let i=cLat-2;i<=cLat+2;i++){
			for(let j=cLng-2;j<=cLng+2;j++){
				const cell=`${i}_${j}`;
				if(accIndex.has(cell)) pts.push(...accIndex.get(cell));
			}
		}
		return pts;
	}
	function filterByBuffer(routeCoords, bufferMeters){
		const sampled = samplePolyline(routeCoords, Math.min(800, bufferMeters));
		const picked = new Set(), res=[];
		for(const s of sampled){
			for(const p of nearbyPoints(s.lat,s.lng)){
				if(haversine(s,p) <= bufferMeters){
					const key=`${p.lat.toFixed(5)}_${p.lng.toFixed(5)}`;
					if(!picked.has(key)){ picked.add(key); res.push(p); }
				}
			}
		}
		return res;
	}

	// ======= SCORE/SELEÇÃO =======
	function scoreRoute(routeCoords, bufferMeters){
		const pts = filterByBuffer(routeCoords, bufferMeters);

		let c3=0,c2=0,c1=0;
		for(const p of pts){
			if(p.alert_level===3) c3++;
			else if(p.alert_level===2) c2++;
			else c1++;
		}

		const risco_total = (c3*5) + (c2*2) + (c1*1);
		const nota = Math.max(0, (10 - (risco_total/10)).toFixed(1)); // escala 0–10

		return { risco_total, nota, c3, c2, c1, points: pts };
	}



	// ========= DESENHO =========
	function drawAttentionPoints(points){
		accLayer.clearLayers();
		points.forEach(p=>{
			const m = L.circleMarker([p.lat,p.lng],{
				radius: p.alert_level===3 ? 14 : p.alert_level===2 ? 11 : 9,
				color: "#fff", weight: 2.5,
				fillColor: p.color, fillOpacity: 1
			}).bindPopup(p.popupHTML, {maxWidth:380});
			m.addTo(accLayer);
		});
	}
	function drawRoutesScored(results,best){
		routesLayer.clearLayers();
		results.forEach(r=>{
			const isBest = r===best;
			L.polyline(r.route.coordinates, {
				color: isBest ? '#10b981' : '#3b82f6',
				weight: isBest ? 6 : 4,
				opacity: isBest ? .95 : .4
			}).addTo(routesLayer);
		});
		map.fitBounds(L.polyline(best.route.coordinates).getBounds(), { padding:[30,30] });
	}
	function updateStats(results){
		const routesInfo = document.getElementById('routesInfo');
		const bestScore = document.getElementById('bestScore');
		const scoreBreak = document.getElementById('scoreBreakdown');

		routesInfo.innerHTML = results.map((r,i)=>
			`Rota ${i+1}: <span class="pill">risco total ${r.risco_total}</span> `+
			`<span class="pill">nota ${r.nota}/10</span> `+
			`<span class="pill">3: ${r.c3}</span> `+
			`<span class="pill">2: ${r.c2}</span> `+
			`<span class="pill">1: ${r.c1}</span>`
		).join('<br>');

		const best = results.reduce((a,b)=> a.risco_total<=b.risco_total ? a : b);
		bestScore.textContent = best.nota + "/10";
		const buf = document.getElementById('buffer').value;
		scoreBreak.innerHTML = `3: <b>${best.c3}</b> · 2: <b>${best.c2}</b> · 1: <b>${best.c1}</b> · Buffer: <b>${buf} m</b>`;
	}




	// =============== ROTEAMENTO ===============
	let control;
	function traceRoute(origin, destination){
		if(control) map.removeControl(control);
		const btn = document.getElementById('go');
		btn.textContent = 'Calculando rota...'; btn.classList.add('loading'); btn.disabled = true;

		control = L.Routing.control({
			waypoints: [ L.latLng(origin[0],origin[1]), L.latLng(destination[0],destination[1]) ],
			router: L.Routing.osrmv1({ serviceUrl: OSRM_SELFHOST_URL, profile: 'driving', timeout: 12000 }),
			show: false, addWaypoints: false, routeWhileDragging: false,
			showAlternatives: true,
			altLineOptions: { styles: [{ color:'#3b82f6', weight:4, opacity:.4, dashArray:'6 8'}] },
			lineOptions: { styles: [{ color:'#10b981', weight:6, opacity:.95 }] }
		})
		.on('routesfound', (e)=>{
			const buffer = parseInt(document.getElementById('buffer').value,10) || 500;
			const routes = (e.routes || []).filter(r => Array.isArray(r.coordinates) && r.coordinates.length);

			if(!routes.length){
				alert('Nenhuma rota encontrada.');
				btn.textContent='Traçar rota segura';
				btn.classList.remove('loading');
				btn.disabled=false;
				return;
			}

			const results = routes.map(r=>{
				try {
					const coords = r.coordinates.map(c=>({lat:c.lat, lng:c.lng}));
					const s = scoreRoute(coords, buffer);
					return { route: r, ...s };
				} catch(err) {
					console.error("Erro ao processar rota:", err, r);
					return null;
				}
			}).filter(Boolean);

			if(!results.length){
				alert('Falha ao processar rotas retornadas.');
				btn.textContent='Traçar rota segura';
				btn.classList.remove('loading');
				btn.disabled=false;
				return;
			}

			const best = results.reduce((a,b)=> a.risco_total<=b.risco_total ? a : b);

			drawRoutesScored(results, best);
			drawAttentionPoints(best.points);
			updateStats(results);

			btn.textContent = 'Traçar rota segura';
			btn.classList.remove('loading');
			btn.disabled = false;
		})


		.on('routingerror', ()=>{
			alert('Erro ao calcular a rota. Verifique o OSRM e tente novamente.');
			btn.textContent = 'Traçar rota segura'; btn.classList.remove('loading'); btn.disabled = false;
		})
		.addTo(map);
	}

	// =============== UI =======================
	document.getElementById('go').addEventListener('click', ()=>{
		const o = document.getElementById('origin').value.split(',').map(parseFloat);
		const d = document.getElementById('destination').value.split(',').map(parseFloat);
		if(o.length<2||d.length<2||Number.isNaN(o[0])||Number.isNaN(d[0])){ alert('Selecione origem e destino válidos.'); return; }
		traceRoute([o[0],o[1]], [d[0],d[1]]);
	});

	// Boot: carrega acidentes
	(async function main(){ await loadAccidents(); })();
	</script>
</body>
</html>
